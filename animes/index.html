<html>

<body>
    <style>
        #animes {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        #animes td,
        #animes th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #animes tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #animes tr:hover {
            background-color: #ddd;
        }

        #animes th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #0491aa;
            color: white;
        }
    </style>

    <form action="#" method="get" target="_self" autocomplete="off" id="search_form">
        <input type="text" id="search_anime_input" name="search_anime_input"><br><br>
        <input onclick=orderByTitle() type="submit" value="Pesquisar">
    </form>

    <table id="animes">
        <thead>
            <th onclick=orderByTitle()> Título </th>
            <th onclick=orderByYear()> Ano </th>
            <th onclick=orderByScore()> Score </th>
            <th> Imagem </th>
        </thead>

        <tbody id="tbody_animes">
        </tbody>

    </table>



    <script>
        let orderTitle = 1;
        let orderYear = 1;
        let orderScore = 1;

        function get_animes(anime = "death") {
            animes_fetch = []
            alert("Os dados estão sendo carregados")
            fetch(`https://api.jikan.moe/v3/search/anime?q=${anime}`)
                .then(T => T.json())
                .then(T => T.results.map((e) => {
                    animes_fetch.push(e)
                }))
                .then(animes = animes_fetch)
        }

        function get_input_animes() {
            var form = document.getElementById('search_form');
            var campo = document.getElementById('search_anime_input');

            form.addEventListener('submit', function (e) {
                if (campo.value.length > 3) {
                    get_animes(campo.value)
                    montarTabela()
                    e.preventDefault()
                } else{
                    alert("Você deve digitar mais do que 3 caracteres")
                }
            });
        }

        var animes = [

            {

                url: "https://myanimelist.net/anime/1535/Death_Note",

                image_url: "https://cdn.myanimelist.net/images/anime/9/9453.jpg?s=b89e80691ac5cc0610847ccbe0b8424a",

                title: "Death Note",

                score: 8.63,

                start_date: "2006-10-04T00:00:00+00:00",

            },

            {

                url: "https://myanimelist.net/anime/28223/Death_Parade",

                image_url: "https://cdn.myanimelist.net/images/anime/5/71553.jpg?s=68833377dab9077cd7847c91eec46f08",

                title: "Death Parade",

                score: 8.18,

                start_date: "2015-01-10T00:00:00+00:00",

            },

            {

                url: "https://myanimelist.net/anime/14353/Death_Billiards",

                image_url: "https://cdn.myanimelist.net/images/anime/11/48721.jpg?s=4728f1efeabefb313634e64ac91f514b",

                title: "Death Billiards",

                score: 7.91,

                start_date: "2013-03-02T00:00:00+00:00",

            }

        ]



        const convertDate = (d) => {
            const date = new Date(Date.parse(d))
            return `${date.getFullYear()}`
        }



        function orderByTitle() {
            animes_update = []
            index = 1
            first_anime = animes[0]
            index_first_anime = 0;

            while (animes.length > 0) {
                while (index < animes.length) {
                    if (orderTitle) {
                        if (animes[index].title < first_anime.title) {
                            first_anime = animes[index]
                            index_first_anime = index;
                        }
                    } else {
                        if (animes[index].title > first_anime.title) {
                            first_anime = animes[index]
                            index_first_anime = index;
                        }
                    }
                    index++
                }
                animes_update.push(first_anime)
                animes.splice(index_first_anime, 1)
                index = 1
                first_anime = animes[0]
                index_first_anime = 0;
            }
            animes = animes_update

            document.getElementById('tbody_animes').innerHTML = "";
            montarTabela()
            orderTitle = !orderTitle
        }

        function orderByYear() {
            animes_update = []
            index = 1
            first_anime = animes[0]
            index_first_anime = 0;

            while (animes.length > 0) {
                while (index < animes.length) {
                    if (orderYear) {
                        if (parseInt(animes[index].start_date) < parseInt(first_anime.start_date)) {
                            first_anime = animes[index]
                            index_first_anime = index;
                        }
                    } else {
                        if (parseInt(animes[index].start_date) > parseInt(first_anime.start_date)) {
                            first_anime = animes[index]
                            index_first_anime = index;
                        }
                    }
                    index++
                }
                animes_update.push(first_anime)
                animes.splice(index_first_anime, 1)
                index = 1
                first_anime = animes[0]
                index_first_anime = 0;
            }
            animes = animes_update

            document.getElementById('tbody_animes').innerHTML = "";
            montarTabela()
            orderYear = !orderYear
        }

        function orderByScore() {
            animes_update = []
            index = 1
            first_anime = animes[0]
            index_first_anime = 0;

            while (animes.length > 0) {
                while (index < animes.length) {
                    if (orderScore) {
                        if (animes[index].score < first_anime.score) {
                            first_anime = animes[index]
                            index_first_anime = index;
                        }
                    } else {
                        if (animes[index].score > first_anime.score) {
                            first_anime = animes[index]
                            index_first_anime = index;
                        }
                    }
                    index++
                }
                animes_update.push(first_anime)
                animes.splice(index_first_anime, 1)
                index = 1
                first_anime = animes[0]
                index_first_anime = 0;
            }
            animes = animes_update
            document.getElementById('tbody_animes').innerHTML = "";
            montarTabela()
            orderScore = !orderScore
        }


        function montarTabela() {
            animes.forEach(anime => {

                // criação dos elementos html
                let tr_row = document.createElement("tr");
                let td_title = document.createElement("td");
                let td_score = document.createElement("td");
                let td_start_date = document.createElement("td");
                let td_image_url = document.createElement("td");
                let img_image = document.createElement("img");

                // definição dos valores

                td_title.innerText = anime.title;
                td_score.innerText = anime.score;
                td_start_date.innerText = convertDate(anime.start_date);
                img_image.src = anime.image_url;

                // estruturação nas linhas

                td_image_url.appendChild(img_image);
                tr_row.appendChild(td_title);
                tr_row.appendChild(td_start_date);
                tr_row.appendChild(td_score);
                tr_row.appendChild(td_image_url);

                // adição na div tbody

                document.getElementById("tbody_animes").appendChild(tr_row);

            })
        }

        get_input_animes()
        montarTabela()
        get_animes()
    </script>

</body>

</html>